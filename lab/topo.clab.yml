name: bgp-anomaly-lab

topology:
  nodes:
    # Spine Switches (Core Layer)
    spine-01:
      kind: linux
      image: frrouting/frr:latest
      cmd: /usr/lib/frr/docker-start
      binds:
        - ./configs/spine-01/frr.conf:/etc/frr/frr.conf:ro
        - ./configs/common/daemons:/etc/frr/daemons:ro
        - ./configs/common/vtysh.conf:/etc/frr/vtysh.conf:ro
        - ./configs/common/zebra.conf:/etc/frr/zebra.conf:ro
        - ./logs/spine-01:/var/log/frr:rw
      env:
        FRR_DAEMONS: "zebra,bgpd"
      labels:
        role: "spine"
        asn: "65001"
        priority: "1"

    spine-02:
      kind: linux
      image: frrouting/frr:latest
      cmd: /usr/lib/frr/docker-start
      binds:
        - ./configs/spine-02/frr.conf:/etc/frr/frr.conf:ro
        - ./configs/common/daemons:/etc/frr/daemons:ro
        - ./configs/common/vtysh.conf:/etc/frr/vtysh.conf:ro
        - ./configs/common/zebra.conf:/etc/frr/zebra.conf:ro
        - ./logs/spine-02:/var/log/frr:rw
      env:
        FRR_DAEMONS: "zebra,bgpd"
      labels:
        role: "spine"
        asn: "65001"
        priority: "2"

    # ToR Switches (Aggregation Layer)
    tor-01:
      kind: linux
      image: frrouting/frr:latest
      cmd: /usr/lib/frr/docker-start
      binds:
        - ./configs/tor-01/frr.conf:/etc/frr/frr.conf:ro
        - ./configs/common/daemons:/etc/frr/daemons:ro
        - ./configs/common/vtysh.conf:/etc/frr/vtysh.conf:ro
        - ./configs/common/zebra.conf:/etc/frr/zebra.conf:ro
        - ./logs/tor-01:/var/log/frr:rw
      env:
        FRR_DAEMONS: "zebra,bgpd"
      labels:
        role: "tor"
        asn: "65002"
        priority: "1"

    tor-02:
      kind: linux
      image: frrouting/frr:latest
      cmd: /usr/lib/frr/docker-start
      binds:
        - ./configs/tor-02/frr.conf:/etc/frr/frr.conf:ro
        - ./configs/common/daemons:/etc/frr/daemons:ro
        - ./configs/common/vtysh.conf:/etc/frr/vtysh.conf:ro
        - ./configs/common/zebra.conf:/etc/frr/zebra.conf:ro
        - ./logs/tor-02:/var/log/frr:rw
      env:
        FRR_DAEMONS: "zebra,bgpd"
      labels:
        role: "tor"
        asn: "65002"
        priority: "2"

    # Edge Routers (Edge Layer)
    edge-01:
      kind: linux
      image: frrouting/frr:latest
      cmd: /usr/lib/frr/docker-start
      binds:
        - ./configs/edge-01/frr.conf:/etc/frr/frr.conf:ro
        - ./configs/common/daemons:/etc/frr/daemons:ro
        - ./configs/common/vtysh.conf:/etc/frr/vtysh.conf:ro
        - ./configs/common/zebra.conf:/etc/frr/zebra.conf:ro
        - ./logs/edge-01:/var/log/frr:rw
      env:
        FRR_DAEMONS: "zebra,bgpd"
      labels:
        role: "edge"
        asn: "65003"
        priority: "1"

    edge-02:
      kind: linux
      image: frrouting/frr:latest
      cmd: /usr/lib/frr/docker-start
      binds:
        - ./configs/edge-02/frr.conf:/etc/frr/frr.conf:ro
        - ./configs/common/daemons:/etc/frr/daemons:ro
        - ./configs/common/vtysh.conf:/etc/frr/vtysh.conf:ro
        - ./configs/common/zebra.conf:/etc/frr/zebra.conf:ro
        - ./logs/edge-02:/var/log/frr:rw
      env:
        FRR_DAEMONS: "zebra,bgpd"
      labels:
        role: "edge"
        asn: "65003"
        priority: "2"

    # Servers (Host Layer)
    server-01:
      kind: linux
      image: frrouting/frr:latest
      cmd: /usr/lib/frr/docker-start
      binds:
        - ./configs/server-01/frr.conf:/etc/frr/frr.conf:ro
        - ./configs/common/daemons:/etc/frr/daemons:ro
        - ./configs/common/vtysh.conf:/etc/frr/vtysh.conf:ro
        - ./configs/common/zebra.conf:/etc/frr/zebra.conf:ro
        - ./logs/server-01:/var/log/frr:rw
      env:
        FRR_DAEMONS: "zebra,bgpd"
      labels:
        role: "server"
        asn: "65010"
        priority: "1"

    server-02:
      kind: linux
      image: frrouting/frr:latest
      cmd: /usr/lib/frr/docker-start
      binds:
        - ./configs/server-02/frr.conf:/etc/frr/frr.conf:ro
        - ./configs/common/daemons:/etc/frr/daemons:ro
        - ./configs/common/vtysh.conf:/etc/frr/vtysh.conf:ro
        - ./configs/common/zebra.conf:/etc/frr/zebra.conf:ro
        - ./logs/server-02:/var/log/frr:rw
      env:
        FRR_DAEMONS: "zebra,bgpd"
      labels:
        role: "server"
        asn: "65011"
        priority: "2"

    server-03:
      kind: linux
      image: frrouting/frr:latest
      cmd: /usr/lib/frr/docker-start
      binds:
        - ./configs/server-03/frr.conf:/etc/frr/frr.conf:ro
        - ./configs/common/daemons:/etc/frr/daemons:ro
        - ./configs/common/vtysh.conf:/etc/frr/vtysh.conf:ro
        - ./configs/common/zebra.conf:/etc/frr/zebra.conf:ro
        - ./logs/server-03:/var/log/frr:rw
      env:
        FRR_DAEMONS: "zebra,bgpd"
      labels:
        role: "server"
        asn: "65012"
        priority: "3"

    server-04:
      kind: linux
      image: frrouting/frr:latest
      cmd: /usr/lib/frr/docker-start
      binds:
        - ./configs/server-04/frr.conf:/etc/frr/frr.conf:ro
        - ./configs/common/daemons:/etc/frr/daemons:ro
        - ./configs/common/vtysh.conf:/etc/frr/vtysh.conf:ro
        - ./configs/common/zebra.conf:/etc/frr/zebra.conf:ro
        - ./logs/server-04:/var/log/frr:rw
      env:
        FRR_DAEMONS: "zebra,bgpd"
      labels:
        role: "server"
        asn: "65013"
        priority: "4"

    # BMP Collector (Go-based BGP monitoring)
    bmp-collector:
      kind: linux
      image: capstone-bmp-collector:latest
      cmd: "./bmp-collector"
      ports:
        - 1790:1790
      labels:
        role: "bmp-collector"
        purpose: "bgp-monitoring"

    # Fluent Bit for log collection
    fluent-bit:
      kind: linux
      image: fluent/fluent-bit:latest
      cmd: /fluent-bit/bin/fluent-bit -c /fluent-bit/etc/fluent-bit.conf
      binds:
        - ./monitoring/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf:ro
        - ./logs:/var/log/lab:ro
        - ./logs/fluent-bit:/var/log/fluent-bit:rw
      labels:
        role: "logging"
        purpose: "log-collection"

  links:
    # Spine-to-Spine (iBGP)
    - endpoints:
        - node: spine-01
          interface: e1
        - node: spine-02
          interface: e1
      type: veth

    # Spine-to-ToR connections
    - endpoints:
        - node: spine-01
          interface: e2
        - node: tor-01
          interface: e1
      type: veth
    - endpoints:
        - node: spine-01
          interface: e3
        - node: tor-02
          interface: e1
      type: veth
    - endpoints:
        - node: spine-02
          interface: e2
        - node: tor-01
          interface: e2
      type: veth
    - endpoints:
        - node: spine-02
          interface: e3
        - node: tor-02
          interface: e2
      type: veth

    # ToR-to-Edge connections
    - endpoints:
        - node: tor-01
          interface: e3
        - node: edge-01
          interface: e1
      type: veth
    - endpoints:
        - node: tor-01
          interface: e4
        - node: edge-02
          interface: e1
      type: veth
    - endpoints:
        - node: tor-02
          interface: e3
        - node: edge-01
          interface: e2
      type: veth
    - endpoints:
        - node: tor-02
          interface: e4
        - node: edge-02
          interface: e2
      type: veth

    # Edge-to-Server connections
    - endpoints:
        - node: edge-01
          interface: e3
        - node: server-01
          interface: e1
      type: veth
    - endpoints:
        - node: edge-01
          interface: e4
        - node: server-02
          interface: e1
      type: veth
    - endpoints:
        - node: edge-02
          interface: e3
        - node: server-03
          interface: e1
      type: veth
    - endpoints:
        - node: edge-02
          interface: e4
        - node: server-04
          interface: e1
      type: veth

    # Collector connections (monitoring)
    - endpoints:
        - node: bmp-collector
          interface: e1
        - node: spine-01
          interface: e4
      type: veth
    - endpoints:
        - node: bmp-collector
          interface: e2
        - node: spine-02
          interface: e4
      type: veth